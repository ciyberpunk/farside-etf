<script>
  function makeChart(canvasId, series, titleText) {
    const ctx = document.getElementById(canvasId).getContext("2d");

    const pos = series.totals.map(v => Math.max(0, v));
    const neg = series.totals.map(v => Math.min(0, v));

    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: series.dates,
        datasets: [
          {
            type: "bar",
            label: "Daily inflow",
            data: pos,
            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--good').trim() || "#1f77b4",
            borderWidth: 0,
            yAxisID: "y2"   // ← bars on RIGHT axis
          },
          {
            type: "bar",
            label: "Daily outflow",
            data: neg,
            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bad').trim() || "#d62728",
            borderWidth: 0,
            yAxisID: "y2"   // ← bars on RIGHT axis
          },
          {
            type: "line",
            label: "Cumulative",
            data: series.cum,
            borderColor: "#ffffff",
            borderWidth: 2,
            pointRadius: 0,
            yAxisID: "y"    // ← line on LEFT axis
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: {
            type: "time",
            time: { unit: "month" },
            ticks: { color: "#c7cfdb" },
            grid: { color: "rgba(255,255,255,0.08)" }
          },
          y: {
            // LEFT axis → cumulative
            title: { text: "USD (millions) - cumulative", display: true, color: "#c7cfdb" },
            ticks: { color: "#c7cfdb" },
            grid: { color: "rgba(255,255,255,0.08)" }
          },
          y2: {
            // RIGHT axis → daily bars
            position: "right",
            title: { text: "USD (millions) - daily", display: true, color: "#c7cfdb" },
            ticks: { color: "#c7cfdb" },
            grid: { drawOnChartArea: false }
          }
        },
        plugins: {
          legend: { labels: { color: "#e9eef5" } },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const val = ctx.parsed.y;
                return ` ${ctx.dataset.label}: ${val.toLocaleString(undefined, { maximumFractionDigits: 1 })}`;
              }
            }
          },
          title: {
            display: true,
            text: titleText,
            color: "#e9eef5",
            font: { weight: "600", size: 14 }
          }
        }
      }
    });
  }
</script>
