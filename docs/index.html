<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Farside ETF flows — BTC & ETH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 1.4rem; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 24px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    canvas { width: 100%; height: 420px; }
    .err { color: #b91c1c; font-weight: 600; margin: 8px 0 0; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Spot ETF flows (daily bars) & cumulative (line)</h1>

  <div class="card">
    <h2 style="margin:0 0 8px;">BTC</h2>
    <canvas id="btcChart"></canvas>
    <div id="btcErr" class="err" hidden></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;">ETH</h2>
    <canvas id="ethChart"></canvas>
    <div id="ethErr" class="err" hidden></div>
  </div>
</div>

<script>
  // --- tiny CSV parser for our simple files ---
  async function readCSV(relPath) {
    const res = await fetch(relPath, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${relPath}`);
    return await res.text();
  }

  function parseNumber(s) {
    if (s == null) return NaN;
    let t = String(s).trim().replace(/,/g, "");
    if (t === "" || t === "-" || t === "–" || t === "—") return 0;
    if (t.startsWith("(") && t.endsWith(")")) t = "-" + t.slice(1, -1);
    const v = Number(t);
    return Number.isFinite(v) ? v : NaN;
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];
    const header = lines[0].split(",").map(h => h.trim().toLowerCase());
    const dateIdx  = header.indexOf("date");
    // Prefer 'total_usd_millions', fall back to 'total'
    let totIdx = header.indexOf("total_usd_millions");
    if (totIdx === -1) totIdx = header.indexOf("total");
    if (dateIdx === -1 || totIdx === -1) return [];

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cols = lines[i].split(",");
      const d = new Date(cols[dateIdx]);
      const t = parseNumber(cols[totIdx]);
      if (!isNaN(d.valueOf()) && Number.isFinite(t)) rows.push({ date: d, total: t });
    }
    return rows;
  }

  // Build series: ensure chronological order and compute cumulative here
  function buildSeries(rows) {
    const data = [...rows].sort((a, b) => a.date - b.date);
    let run = 0;
    const labels = [];
    const pos = [];
    const neg = [];
    const cum = [];
    for (const r of data) {
      run += r.total;
      labels.push(r.date);
      pos.push(Math.max(r.total, 0));
      neg.push(Math.min(r.total, 0));
      cum.push(run);
    }
    return { labels, pos, neg, cum };
  }

  function fmt(n) {
    return new Intl.NumberFormat("en-US", { maximumFractionDigits: 1 }).format(n);
  }

  function makeChart(canvasId, series, title) {
    const ctx = document.getElementById(canvasId).getContext("2d");

    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: series.labels,
        datasets: [
          {
            type: "bar",
            label: "Daily inflow",
            data: series.pos,
            yAxisID: "yDaily",
            borderWidth: 0,
            backgroundColor: "#1f77b4",
            order: 2
          },
          {
            type: "bar",
            label: "Daily outflow",
            data: series.neg,
            yAxisID: "yDaily",
            borderWidth: 0,
            backgroundColor: "#d62728",
            order: 2
          },
          {
            type: "line",
            label: "Cumulative",
            data: series.cum,
            yAxisID: "yCum",
            borderColor: "#111",
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.15,
            order: 1
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        parsing: false,
        scales: {
          x: {
            type: "time",
            time: { unit: "month" },
            grid: { display: false }
          },
          yDaily: {
            position: "left",
            title: { display: true, text: "USD millions (daily)" },
            grid: { drawOnChartArea: true }
          },
          yCum: {
            position: "right",
            title: { display: true, text: "USD millions (cumulative)" },
            grid: { drawOnChartArea: false }
          }
        },
        plugins: {
          title: { display: true, text: title },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const ds = ctx.dataset;
                const v = ctx.parsed.y;
                if (ds.yAxisID === "yCum") {
                  return ` ${ds.label}: ${fmt(v)} M`;
                } else {
                  // daily bars (pos or neg)
                  const sign = v >= 0 ? "+" : "";
                  return ` ${ds.label}: ${sign}${fmt(v)} M`;
                }
              }
            }
          },
          legend: { position: "top" }
        }
      }
    });
  }

  async function loadAndPlot(canvasId, csvRelPath, title, errId) {
    try {
      // Relative paths work on GitHub Pages since index.html and Data/ share the same folder (docs/)
      const csvText = await readCSV(csvRelPath);
      const rows = parseCSV(csvText);
      if (!rows.length) throw new Error("No rows parsed.");
      const series = buildSeries(rows);
      makeChart(canvasId, series, title);
    } catch (e) {
      console.error(e);
      const el = document.getElementById(errId);
      el.hidden = false;
      el.textContent = `Failed to load ${csvRelPath}: ${e.message}`;
    }
  }

  // Kick off both charts (paths are relative to docs/index.html)
  loadAndPlot("btcChart", "Data/bitcoin_etf_totals_daily.csv",
              "BTC spot ETF — daily flows (bars) & cumulative (line)", "btcErr");
  loadAndPlot("ethChart", "Data/ethereum_etf_totals_daily.csv",
              "ETH spot ETF — daily flows (bars) & cumulative (line)", "ethErr");
</script>
</body>
</html>
